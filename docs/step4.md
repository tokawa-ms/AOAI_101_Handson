# Azure OpenAI と AI オーケストレーターを使った賢いアプリケーションを実装する

## サンプルアプリのダウンロード

[サンプルアプリ](https://github.com/ayako/BuildJapan2023AOAIDemo/blob/main/RecipeCreatorApp202306.zip) をダウンロードし、Zipファイルを分かりやすいディレクトリに展開しておきます。

## OpenAI Service の準備
Azure Portal で OpenAI Service を開き、今回利用する OpenAI Service のアカウントの以下の情報をメモします。（[step1](./step1.md) で作成した Azure OpenAI のアカウントで構いません。）

- API Endpoint
- API Key

また、Azure OpenAI Studio で、モデルとして "gpt-35-turbo" が設定されたデプロイがあるか確認してください。確認が出来たら以下の情報をメモします。

- デプロイ名
## サンプルアプリを触ってみる

展開した Zip ファイルの中には二つのディレクトリが存在します。
そのうち "RecipeCreatorApp202306" というディレクトリの方が、今回利用するサンプルアプリのディレクトリですので、そのディレクトリで Visual Studio Code で開きます。

エクスプローラーのコンテキストメニューに "Code で開く" を追加しているようでしたら、そこから開けば OK です。
もしコンテキストメニューが無かった場合には、VS Code を開いた後に "Files" > "Open Folder" のメニューから、サンプルアプリのディレクトリ内にある "RecipeCreatorApp202306" ディレクトリを開いてください。

![](./img/SampleApp01.png)

**[このフォルダー内のファイルの作成者を信頼しますか]** というメッセージが表示されたら、**[はい...]** をクリックして進みます。

![](./img/SampleApp02.png)

左バナーの **エクスプローラー** をクリックして、フォルダー＆ファイルを表示します。

**[ビルドおよびデバッグに必要な資産がありません...]** というメッセージが表示されたら、**[はい]** をクリックして作成します。

![](./img/SampleApp03.png)

エクスプローラーから **Pages** > **index.cshtml.cs** をクリックして表示します。 

28行目にある Azure OpenAI Service の情報 (デプロイしたモデルのエンドポイント (URL) 、API Key、デプロイ名) を設定します。

以下のような形で、第一引数に「デプロイ名」、第二引数に「モデルのエンドポイント」、第三引数に「API Key」をそれぞれ設定します。

```c#(抜粋)
                .WithAzureChatCompletionService("デプロイ名", "モデルのエンドポイント", "APIKey")
```

![](./img/SampleApp04.png)

左バナーから **[実行とデバッグ]** をクリックして開きます。**▷** をクリックして、デバッグ実行します。

![](./img/SampleApp05.png)

ブラウザーが立ち上がり、アプリが表示されます。

**[献立メニューを作る]** をクリックすると、Azure OpenAI Service によって生成された献立メニューが画面右側に表示されます。
そのあと **[栄養アドバイスを見る]** をクリックすると、同様に生成された健康アドバイスが画面左下に表示されます

![](./img/SampleApp06.png)

## サンプルアプリのデプロイ

### Azure Portal から Web アプリの作成

ブラウザーで **[Azure Portal](https://portal.azure.com)** を開きます。

**[＋リソースの作成]** をクリックします。

![](./img/CreateWebApp01.png)

**リソースの作成** 画面から **Web アプリ** の作成 をクリックして、Web アプリ作成メニューを開きます。

![](./img/CreateWebApp02.png)

**Web アプリの作成** 画面で必要な項目を設定します。

**リソースグループ** は 作成済みの リソースグループを選択、または**新規作成** をクリックして、お好みの名前を入力してください。

![](./img/CreateWebApp03.png)

**インスタンスの詳細**

- **名前** : お好みの名前を設定してください
- **公開** : コード
- **ランタイムスタック** :　**.NET 7 (STS)**
- **オペレーティングシステム** : Windows
- **地域** : Japan East

![](./img/CreateWebApp04.png)

**価格プラン**

- **Windows プラン** : 作成済みのプランを選択する、または**新規作成** をクリックして、お好みの名前を入力

入力できたら、**[確認および作成]** をクリックして次に進みます。

![](./img/CreateWebApp05.png)

構成の確認が終わったら **[作成]** をクリックして Web アプリを作成します。

![](./img/CreateWebApp06.png)

デプロイ画面に遷移し、**デプロイが完了しました** と表示されたら、Web アプリの作成は完了です。

![](./img/CreateWebApp07.png)

### サンプルアプリを Azure にデプロイ

Visual Studio Code に戻ります。
 
左バナーの **[Azure]** をクリックします。**Resources** > (お使いのサブスクリプション名) > **App Services** をクリックして開き、作成した Web アプリを表示します。

Web アプリを右クリックして、**Deploy to Azure** をクリックします。

![](./img/DeployToAzure01.png)

画面上部にコマンドパレットが表示されます。ローカルのサンプルアプリを選択します。

![](./img/DeployToAzure02.png)

**Required confiration to deploy is missing...** と表示されたら、**[Add config]** をクリックして設定ファイルを自動生成します。

![](./img/DeployToAzure03.png)

**Are you sure to deploy... (上書きします)** と表示されますが、**Deploy** をクリックしてデプロイを実行します。

![](./img/DeployToAzure04.png)

画面右下に **[Deploying ...]** と表示されて、デプロイが実行されます。メッセージが **[Deployed]** になると、ブラウザーが起動して Azure にデプロイされた Web アプリが表示されます。

![](./img/DeployToAzure05.png)

## サンプルアプリを深追いしてみる
### Semantic Kernel について
このサンプルアプリでは、Microsoft がスポンサーとなって OSS にて開発が進められている AI オーケストレーターである、[Semantic Kernel](https://learn.microsoft.com/en-us/semantic-kernel/overview/) が利用されています。

オーケストレーターを使うことで、LLM 自身がユーザーの要望を達成する為に行うべきタスクを選び取り実行するような、インテリジェントなアプリケーションの実装を用意にすることが可能です。
また、LLM を使ったアプリケーションに必要な、外部とのデータ接続や記憶の構成に関する部分を抽象化するような仕組みも備わっているため、アプリケーションの実装をシンプルにすることが可能です。
例えば、Azure OpenAI 以外にも、本家の OpenAI に接続するような構成も設定ひとつで可能ですし、Hugging Face にあるモデルを読み込むこともできます。

ここから先は、サンプルプロジェクトの中身を探検することで、Semantic Kernel の主な機能を幾つか紹介していければと思います。

### Kernel
Semantic Kernel における、"Kernel" は、利用できる様々な機能（プラグインといいます）を組み合わせて、ユーザーの要求を満たす処理エンジンのインスタンスのことです。
"Kernel" というとコンピューターに詳しい方なら、オペレーティングシステムのコアとなる "Kernel" を思い出すかと思いますが、まさに AI オペレーティングシステムのコアとなるものと考えて良いかと思います。

以下のような機能が Kernel の領分となります。

- AI に自律的に実行する処理を決定させる
- 各種の外部サービス (OpenAI, Azure OpenAI, Hugging Face) への接続情報の構成
- ログ機能

今回のサンプルコードでいうと、以下のコードブロックが、Kernel の設定を行う部分になっています。シンプルに Azure OpenAI の Chat Completion Service への接続情報を設定しているだけのコードですね。

```C#
            kernel = new KernelBuilder()
                .WithAzureChatCompletionService("デプロイ名", "モデルのエンドポイント", "APIKey")
                .Build();
```

例えば、このコードを本家 OpenAI をバックエンドとして使って動かしたい！と思ったらどうなるでしょうか？
実は、真ん中の `WithAzureChatCompletionService()` の呼び出しを以下の様に OpenAI の接続情報に書き換えるだけで可能です。

```C#
.WithOpenAIChatCompletionService(
    "gpt-3.5-turbo",                        // OpenAI Model Name
    "...your OpenAI API Key...",            // OpenAI API key
    "...your OpenAI Org ID..."              // *optional* OpenAI Organization ID
)
```

PC に繋ぐドライブのメーカーがなんであれ、OS が抽象化して同じ「ドライブ」としてアクセスできるように、Semantic Kernel の後ろで動く LLM が何であれ、この Kernel が抽象化を行い、個別の AI のインターフェイスなど知らなくても LLM の活用を簡単に行えるようになるわけです。

### Semantic Function
さて、Semantic Kernel がユーザーの要求を満たすために使う機能（プラグイン）はどうやって実装されているのでしょうか？ゴリゴリと C# や Python といったプログラム言語で書かれていると思われている方も多いと思うので、"Semantic Function" についてもご紹介します。

サンプルプロジェクトを VS Code で開いて、Skills\RecipeCreatorSkill\Recipe ディレクトリをファイルエクスプローラーで見てみてください。
すると、skprompt.txt と config.json の二つのファイルがディレクトリに入っていると思います。

実は、この二つのファイルが、Semantic Function の定義の実体です。
config.json は Semantic Kernel に対して、そのプラグインがどのような機能を持っているのかを通知するための説明文や、LLM に与えるパラメーターが記載されています。
そして、skprompt.txt には、該当する機能が呼び出されたときに、どのようなプロンプトで LLM を呼び出すのか、というプロンプトそのものが書かれています。

![](./img/SKSkill001.png)

C# や Python といったプログラミング言語ではなく、自然言語でアプリケーションの機能が実装されている、これが LLM を上手く活用するアプリケーションの大きな特徴と言えるかと思います。

#### Semantic Function で遊んでみる
いまのところ、Skills\RecipeCreatorSkill\Recipe\skprompt.txt には以下の内容が書いてあると思います。

```txt
あなたは家族の料理担当です。家族の健康に配慮したバランスの良い献立メニューを考えてください。
献立メニューは、主菜、副菜、主食、汁物を必ず1品ずつ、合計4品提案してください。
献立メニューを作るのに必要な材料をリストアップしてください。
家にある食材をなるべく使い、足りない材料をリストアップしてください。
献立メニューの作り方をリストアップしてください。
どのように健康に配慮して献立メニューを提案したのかを記述してください。

家にある食材: {{$ingredients}}
家族構成: {{$family}}

必ず下記ルールのJSONデータのみ回答してください。JSONデータの前と後に平文はつけないでください。
・"menu" の値には、献立メニューの一覧をセットしてください。
・"ingredients_notstock" の値には、献立メニューの材料のうち家にない食材をセットしてください。
・"point" の値には、献立メニューの理由をセットしてください。
・"recipe" の値には、献立メニューの作り方をセットしてください。
以下はJSONデータのフォーマット例です。
{
   "menu":"・主菜: 鶏むね肉のハーブ焼き\n・副菜: ほうれん草のおひたし\n・主食: ご飯\n・汁物: 豆腐の味噌汁",
   "ingredients_notstock":"ハーブ（ローズマリー、タイムなど）、米、豆腐、出汁、調味料(塩、胡椒、オリーブオイル、酢、醤油、味噌)",
   "point":"健康に配慮した献立メニューを提案するために、低脂肪の鶏むね肉にハーブを加えてオリーブオイルで焼くことで脂質を抑えたメニューを主菜に、ほうれん草を副菜にしました。主食は主菜に合うご飯、汁物はたんぱく質をとれるように豆腐の味噌汁にしました。息子が嫌いなナスと娘がアレルギーを持っている卵を使わない献立メニューにしました。",
   "recipe":"・鶏むね肉のハーブ焼き：鶏むね肉を塩胡椒で味付けし、オリーブオイルを加えてハーブを混ぜ合わせる。フライパンに入れて焼く。\n・ほうれん草のおひたし：ほうれん草を切り、オリーブオイルを加えて塩胡椒で味付けする。\n・ご飯：米を炊飯器に入れ、水を入れて炊く。\n・豆腐の味噌汁：出汁を鍋に入れ、豆腐を切って加える。火を通して温め、味噌を溶かす。"
}
```

これを、ちょっと書き換えて応答結果がどんなふうに変わるのか実験してみましょう。

例えばこんな感じで、副菜を二つにするように指示を変えてみましょう。

```txt
あなたは家族の料理担当です。家族の健康に配慮したバランスの良い献立メニューを考えてください。
献立メニューは、主菜、副菜を2品、主食、汁物を必ず1品ずつ、合計5品提案してください。
献立メニューを作るのに必要な材料をリストアップしてください。
家にある食材をなるべく使い、足りない材料をリストアップしてください。
献立メニューの作り方をリストアップしてください。
どのように健康に配慮して献立メニューを提案したのかを記述してください。

家にある食材: {{$ingredients}}
家族構成: {{$family}}

必ず下記ルールのJSONデータのみ回答してください。JSONデータの前と後に平文はつけないでください。
・"menu" の値には、献立メニューの一覧をセットしてください。
・"ingredients_notstock" の値には、献立メニューの材料のうち家にない食材をセットしてください。
・"point" の値には、献立メニューの理由をセットしてください。
・"recipe" の値には、献立メニューの作り方をセットしてください。
以下はJSONデータのフォーマット例です。
{
   "menu":"・主菜: 鶏むね肉のハーブ焼き\n・副菜: ほうれん草のおひたし\n・主食: ご飯\n・汁物: 豆腐の味噌汁",
   "ingredients_notstock":"ハーブ（ローズマリー、タイムなど）、米、豆腐、出汁、調味料(塩、胡椒、オリーブオイル、酢、醤油、味噌)",
   "point":"健康に配慮した献立メニューを提案するために、低脂肪の鶏むね肉にハーブを加えてオリーブオイルで焼くことで脂質を抑えたメニューを主菜に、ほうれん草を副菜にしました。主食は主菜に合うご飯、汁物はたんぱく質をとれるように豆腐の味噌汁にしました。息子が嫌いなナスと娘がアレルギーを持っている卵を使わない献立メニューにしました。",
   "recipe":"・鶏むね肉のハーブ焼き：鶏むね肉を塩胡椒で味付けし、オリーブオイルを加えてハーブを混ぜ合わせる。フライパンに入れて焼く。\n・ほうれん草のおひたし：ほうれん草を切り、オリーブオイルを加えて塩胡椒で味付けする。\n・ご飯：米を炊飯器に入れ、水を入れて炊く。\n・豆腐の味噌汁：出汁を鍋に入れ、豆腐を切って加える。火を通して温め、味噌を溶かす。"
}
```

変更が終わったら、クラウドにデプロイしなおさなくても OK なので、VS Code でサンプルプロジェクトをデバッグ実行してみましょう。
すると、こんな感じで意図取りに副菜が 2 つになった結果が返ってくるはずです。（…が、たまにいうことを聞いてくれないこともあります）

![](./img/SKSkill002.png)